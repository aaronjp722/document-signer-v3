<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Document Dispatch | Internal Sign</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
  :root {
  --bg: #0b1220;
  --card: #111827;
  --text-main: #e5e7eb;
  --text-sub: #9ca3af;
  --border: rgba(255,255,255,.12);
  --primary: #3b82f6;
  --success: #22c55e;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text-main);
  margin: 0;
  padding: 40px 20px;
}


  .container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    margin-bottom: 24px;
  }

  .section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 8px;
  }

  input,
select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: #020617;
  color: var(--text-main);
}

input::placeholder {
  color: #64748b;
}

select option {
  background: #020617;
  color: var(--text-main);
}


  .file-upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
  }

  .file-upload-zone:hover {
    border-color: var(--primary);
    background: #f0f7ff;
  }

  /* ================================
   DARK TOOL BUTTONS
================================ */

.tool-btn {
  background: #020617;
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 8px;
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
}

.tool-btn:hover {
  background: #020617;
  border-color: #3b82f6;
  color: #ffffff;
}

/* Active state (Signature selected, active signer, etc.) */
.tool-btn.active {
  background: linear-gradient(180deg,#2563eb,#1d4ed8);
  border-color: #2563eb;
  color: #ffffff;
  box-shadow: 0 0 0 1px rgba(59,130,246,.4);
}

/* Disabled look (optional but clean) */
.tool-btn:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}


  #pdf-page-mock {
    width: 100%;
    height: 800px;
    background: white;
    position: relative;
    cursor: crosshair;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
  }

  .dropped-field {
    position: absolute;
    padding: 6px 12px;
    background: var(--primary);
    color: white;
    font-size: 10px;
    font-weight: bold;
    border-radius: 4px;
    transform: translate(-50%, -50%);
    pointer-events: none;
    text-transform: uppercase;
  }

  .btn-send {
    background: var(--primary);
    color: white;
    border: none;
    padding: 16px;
    border-radius: 12px;
    font-weight: 700;
    width: 100%;
    cursor: pointer;
    margin-top: 20px;
  }

  hr {
    border: 0;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }
  
  #overlay-layer { pointer-events: none; }
  
  /* Draggable signature fields */
.signature-box {
  position: absolute;
  min-width: 20px;
  min-height: 10px;
  padding: 6px 10px;
  background: rgba(37, 99, 235, 0.15);
  border: 2px dashed #2563eb;
  color: #2563eb;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  cursor: move;
  user-select: none;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

#pdf-viewer {
  position: relative;
}

.signature-box.selected {
  outline: 2px solid #2563eb;
  background: rgba(37,99,235,0.25);
}


/* ================================
   RESIZE HANDLES (8 directions)
================================ */

.signature-box .resize-handle {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #2563eb;
  z-index: 20;
}

.resize-t { top: -5px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.resize-b { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.resize-l { left: -5px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }
.resize-r { right: -5px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }

.resize-tl { top: -5px; left: -5px; cursor: nwse-resize; }
.resize-tr { top: -5px; right: -5px; cursor: nesw-resize; }
.resize-bl { bottom: -5px; left: -5px; cursor: nesw-resize; }
.resize-br { bottom: -5px; right: -5px; cursor: nwse-resize; }

.signature-box[data-signer="1"] { border-color:#2563eb; color:#2563eb; }
.signature-box[data-signer="2"] { border-color:#16a34a; color:#16a34a; }
.signature-box[data-signer="3"] { border-color:#d97706; color:#d97706; }
.signature-box[data-signer="4"] { border-color:#dc2626; color:#dc2626; }

.signature-box[data-signer="1"] { border-color:#2563eb; color:#2563eb; }
.signature-box[data-signer="2"] { border-color:#16a34a; color:#16a34a; }
.signature-box[data-signer="3"] { border-color:#ea580c; color:#ea580c; }
.signature-box[data-signer="4"] { border-color:#7c3aed; color:#7c3aed; }

.signature-box[data-signer="2"] { background:rgba(22,163,74,.15); }
.signature-box[data-signer="3"] { background:rgba(234,88,12,.15); }
.signature-box[data-signer="4"] { background:rgba(124,58,237,.15); }

/* ================================
   DARK CANDIDATE DROPDOWN
================================ */

.candidate-dropdown {
  position: absolute;
  background: #020617; /* deep dark */
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 10px;
  margin-top: 6px;
  max-height: 280px; /* ~10 items */
  overflow-y: auto;
  width: 100%;
  z-index: 50;
  box-shadow: 0 20px 40px rgba(0,0,0,.55);
}

/* Scrollbar (WebKit) */
.candidate-dropdown::-webkit-scrollbar {
  width: 8px;
}
.candidate-


.candidate-item {
  padding: 10px 12px;
  cursor: pointer;
  font-size: 13px;
}

.candidate-item:hover {
  background: #f1f5f9;
}

.hidden {
  display: none;
}

</style>

</head>
<body>

<div class="container">
    <div style="margin-bottom: 30px;">
        <h1 style="margin:0;">Prepare Signature Request</h1>
        <p style="color: var(--text-sub);">Neat Necessary Cleaning | Internal HR Portal</p>
    </div>

    <form id="hr-dispatch-form">
        <div class="dashboard-grid">
            <div class="main-col">
                <div class="card">
                   
   

<div class="section-title">Quick Resources</div>
<div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
    <button type="button" class="tool-btn" onclick="requestResourceDoc('Insurance')">Insurance</button>
    <button type="button" class="tool-btn" onclick="requestResourceDoc('Supply List')">Supply List</button>
    <button type="button" class="tool-btn" onclick="requestResourceDoc('Login Instructions')">Login Instr.</button>
    <button type="button" class="tool-btn" onclick="requestResourceDoc('Schedule Instructions')">Schedule Instr.</button>
</div>
<hr>                

<div class="section-title">Signers</div>



<!-- Signer Count -->
<div class="form-group" style="max-width:240px;">
  <label>Number of Signers</label>
  <select id="signer_count" onchange="updateSignerVisibility()">
    <option value="1">1 Signer</option>
    <option value="2">2 Signers</option>
    <option value="3">3 Signers</option>
    <option value="4">4 Signers</option>
  </select>
</div>

<!-- Signer 1 (Candidate) + Jira -->
<div
  class="form-group"
  style="display:grid; grid-template-columns: auto 1fr 1fr 1fr; gap:12px; align-items:end;"
>

  <!-- GET BUTTON -->
  <div>
    <label>&nbsp;</label>
    <button
      type="button"
      class="tool-btn"
      style="
        width:42px;
        height:42px;
        padding:0;
        font-weight:700;
      "
      onclick="fetchCandidates()"
      title="Load candidates"
    >
      Get
    </button>
  </div>

  <!-- SIGNER NAME -->
  <div style="position:relative;">
    <label>Signer 1 Name</label>
    <input
      type="text"
      id="signer1_name"
      placeholder="Start typing or select"
      oninput="filterCandidates(this.value)"
    >
    <div
      id="candidate-dropdown"
      class="candidate-dropdown hidden"
    ></div>
  </div>

  <!-- EMAIL -->
  <div>
    <label>Signer 1 Email</label>
    <input type="email" id="signer1_email">
  </div>

  <!-- JIRA -->
  <div>
    <label>Jira Ticket / Job Code</label>
    <input type="text" id="jira_code" placeholder="HR-1245">
  </div>

</div>



<!-- Signer 2 -->
<div id="signer2_row" style="display:none; margin-top:15px;">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
    <div class="form-group">
      <label>Signer 2 Name</label>
      <input type="text" id="signer2_name">
    </div>
    <div class="form-group">
      <label>Signer 2 Email</label>
      <input type="email" id="signer2_email">
    </div>
  </div>
</div>

<!-- Signer 3 -->
<div id="signer3_row" style="display:none; margin-top:15px;">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
    <div class="form-group">
      <label>Signer 3 Name</label>
      <input type="text" id="signer3_name">
    </div>
    <div class="form-group">
      <label>Signer 3 Email</label>
      <input type="email" id="signer3_email">
    </div>
  </div>
</div>

<!-- Signer 4 -->
<div id="signer4_row" style="display:none; margin-top:15px;">
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
    <div class="form-group">
      <label>Signer 4 Name</label>
      <input type="text" id="signer4_name">
    </div>
    <div class="form-group">
      <label>Signer 4 Email</label>
      <input type="email" id="signer4_email">
    </div>
  </div>
</div>


<div class="form-group">
  <label>Document Title</label>
  <input
    type="text"
    id="document_title"
    placeholder="Title Text"
  >
</div>


<div class="form-group">
  <label>Select Template</label>
<select name="template" id="template-select">
  <option value="">â€” Select a template â€”</option>
  <option value="Contractor Agreement">Contractor Agreement</option>
  <option value="Background Check Agreement">Background Check Agreement</option>
  <option value="W-9">W-9</option>
</select>

</div>

<div class="section-title" style="margin-top:28px;">
  Custom Email Message
</div>

<div class="form-group">
  <label>Email Message (optional)</label>
  <textarea
    id="custom_email_message"
    rows="6"
    placeholder="Hi {{first_name}}, please review and sign the attached document."
    style="
      width:100%;
      padding:12px;
      border-radius:8px;
      background:#020617;
      border:1px solid var(--border);
      color:var(--text-main);
      resize:vertical;
      font-family:Inter;
      font-size:14px;
    "
  ></textarea>
</div>

<hr>

                    <div class="file-upload-zone" id="drop-zone">
                        <div style="font-size: 20px;">ðŸ“„</div>
                        <div id="upload-text">Click to upload custom PDF</div>
                        <input type="file" id="file-input" style="display:none" accept=".pdf">
                    </div>
                </div>

                <div id="annotation-zone" class="card">
                    <div class="section-title">2. Place Required Fields</div>
                    <div class="field-toolbar" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="tool-btn active" id="btn-sig" onclick="setFieldType('signature', this)">Signature</button>
                        <button type="button" class="tool-btn" id="btn-init" onclick="setFieldType('initials', this)">Initials</button>
                        <button type="button" class="tool-btn" id="btn-date" onclick="setFieldType('date', this)">Date</button>
                        <button
                          type="button"
  												class="tool-btn"
                          id="btn-text"
  												onclick="setFieldType('text', this)"                
														>Text
                         </button>

<button
  type="button"
  class="tool-btn"
  id="btn-name"
  onclick="setFieldType('name', this)"
>
  Name
</button>
													<!-- SIGNER SELECTOR (1â€“4) -->
<div style="display:flex; gap:6px; margin-left:auto;">
  <button
    type="button"
    class="tool-btn active"
    id="btn-signer1"
    onclick="setSigner(1, this)"
  >Signer 1</button>

  <button
    type="button"
    class="tool-btn"
    id="btn-signer2"
    onclick="setSigner(2, this)"
  >Signer 2</button>

  <button
    type="button"
    class="tool-btn"
    id="btn-signer3"
    onclick="setSigner(3, this)"
  >Signer 3</button>

  <button
    type="button"
    class="tool-btn"
    id="btn-signer4"
    onclick="setSigner(4, this)"
  >Signer 4</button>
</div>

                    </div>

                    <div id="pdf-container" style="background: #525659; padding: 20px; border-radius: 12px; height: 600px; overflow-y: auto;">
                        <div id="pdf-viewer">
                            <div id="overlay-layer" style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>
                            <p style="text-align: center; color: #ccc; margin-top: 100px;">Click here to place tags</p>
                        </div>
                    </div>
                    <input type="hidden" name="coordinates" id="coord-data">
                </div>
            </div>

            <div class="side-col">
                <div class="card" style="position: sticky; top: 20px;">
                    <div class="section-title">Final Review</div>
                    <div style="font-size: 13px; color: var(--text-sub);">
                        <p>Status: <b style="color: var(--success)">Ready</b></p>
                        <p>Method: <b>Secure Digital</b></p>
                    </div>
                    <hr>
                    <label>Link Expiry</label>
                    <select><option>48 Hours</option><option>7 Days</option></select>
                    <button type="button" class="btn-send" onclick="submitData()">Send for Signature</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://rfdvogakvyodixgpvqvz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZHZvZ2FrdnlvZGl4Z3B2cXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzU4MDMsImV4cCI6MjA4MjYxMTgwM30.UumTuz6AaKL8uYmmNxFj1ec5CInHVNQowt6LRo4cu-E";

const sb = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>


<script>

const TEMPLATE_PDFS = {
  "Contractor Agreement":
    "https://cdn.prod.website-files.com/69304921ad4eb233dbdc0a22/6956f001423a4b377eca1168_Independent_Contractor_Agreement%202025%20(1)%20(2).pdf",

  "W-9":
    "https://cdn.prod.website-files.com/69304921ad4eb233dbdc0a22/6956ef4c44c9c6130a98b9ab_fw9%20(1)%20(3).pdf",

  "Background Check Agreement":
    "https://cdn.prod.website-files.com/69304921ad4eb233dbdc0a22/6956effd35fb3e3b041f3208_Neat_Necessary_Cleaning_Background_Check_Form%20(2)%20(2).pdf"
};




const MAKE_WEBHOOK_URL = "https://hook.us1.make.com/nzft5pdep4ndl9kxhmw6nakhidje3p77";

/* ===============================
   SIGN FLOW HELPERS (NEW)
=============================== */

const SIGN_PAGE_BASE =
  "https://neatnecessarycleaning.com/sign-document";

function generateToken() {
  return crypto.randomUUID().replace(/-/g, "");
}

function generateDocId() {
  return "doc_" + Date.now();
}

const RESOURCE_WEBHOOK_URL = "https://hook.us1.make.com/4ht70jpe4reumtxoj61c2khktdk3gt1v";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let selectedBox = null;
let currentSigner = 1; // default signer


// ================================
// ðŸ”¥ SUPABASE FILE UPLOAD
// ================================
async function uploadPdfToSupabase(file) {
  const fileExt = file.name.split('.').pop();
  const fileName = `${crypto.randomUUID()}.${fileExt}`;
  const filePath = `uploads/${fileName}`;

  const { error } = await sb.storage
    .from("documents")
    .upload(filePath, file, {
      cacheControl: "3600",
      upsert: false
    });

  if (error) throw error;

  // ðŸ”‘ Get public URL
  const { data } = sb.storage
    .from("documents")
    .getPublicUrl(filePath);

  return data.publicUrl;
}



/*RENDER PDF */
async function renderPDF(url) {
  const viewer = document.getElementById("pdf-viewer");
  viewer.innerHTML = "";

  const pdf = await pdfjsLib.getDocument(url).promise;

  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.2 });

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: ctx,
      viewport
    }).promise;

    const pageWrap = document.createElement("div");
pageWrap.className = "page-container";
pageWrap.dataset.page = pageNum;
pageWrap.style.position = "relative";
pageWrap.style.width = canvas.width + "px";
pageWrap.style.height = canvas.height + "px";

pageWrap.appendChild(canvas);
viewer.appendChild(pageWrap);

  }
}

// ðŸ”‘ REQUIRED: wire upload elements
const fileInput = document.getElementById('file-input');
const dropZone = document.getElementById('drop-zone');

dropZone.addEventListener('click', () => {
  fileInput.click();
});

    let currentFieldType = 'signature';
    let fieldList = [];

function resetDocumentState() {
  // 1ï¸âƒ£ Remove all placed fields from DOM
  document.querySelectorAll(".signature-box").forEach(el => el.remove());

  // 2ï¸âƒ£ Clear field data
  fieldList = [];

  // 3ï¸âƒ£ Reset selection + drag state
  selectedBox = null;
  activeDrag = null;
  resizeTarget = null;
  resizeDir = null;

  // 4ï¸âƒ£ Optional: reset signer to 1 (safe default)
  currentSigner = 1;

  console.log("ðŸ§¹ Document state reset");
}


  // File Upload Handler
fileInput.onchange = async () => {
  resetDocumentState();

  const file = fileInput.files[0];
  if (!file) return;

  // ================================
  // ðŸ”¥ UPLOAD TO SUPABASE STORAGE
  // ================================
  let publicUrl = null;

  try {
    publicUrl = await uploadPdfToSupabase(file);
    console.log("Uploaded to Supabase:", publicUrl);
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Failed to upload file to Supabase");
    return;
  }

  // Store URL globally so submitData can use it
  window.UPLOADED_PDF_URL = publicUrl;

  // Show filename in UI
  document.getElementById("upload-text").innerHTML = "âœ“ " + file.name;

  // ================================
  // ðŸ”¥ AUTO TITLE FROM FILE
  // ================================
  const titleInput = document.getElementById("document_title");

  if (titleInput && !titleInput.dataset.manual) {
    const cleanName = file.name.replace(/\.pdf$/i, "");
    titleInput.dataset.uploadName = cleanName;
    titleInput.value = cleanName;
  }

  // Render PDF using PUBLIC URL (not blob)
  renderPDF(publicUrl);
};





    
    // Field Selector Handler
    function setFieldType(type, btn) {
        currentFieldType = type;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
let activeDrag = null;
const pdfViewer = document.getElementById('pdf-viewer');

// Create a draggable box
function createSignatureBox(type) {
  const box = document.createElement('div');
  box.className = 'signature-box';
  box.dataset.type = type;
  box.dataset.signer = currentSigner;
box.addEventListener('click', (e) => {
  e.stopPropagation();
  selectBox(box);
});

/*Helper*/
function selectBox(box) {
  document.querySelectorAll('.signature-box')
    .forEach(b => b.classList.remove('selected'));

  selectedBox = box;
  box.classList.add('selected');
}


  if (type === 'text') {
  box.innerText = `Text â€“ Signer ${currentSigner}`;
  box.contentEditable = true;
  box.style.minWidth = '160px';
}

if (type === 'name') {
  const nameInput = document.getElementById(`signer${currentSigner}_name`);
  box.innerText = nameInput?.value || `Name â€“ Signer ${currentSigner}`;
  box.contentEditable = false; // ðŸ”’ names are locked
  box.style.minWidth = '160px';
}

if (type !== 'text' && type !== 'name') {
  box.innerText = type.toUpperCase();
}


  // Drag logic
  box.addEventListener('mousedown', (e) => {
  // âŒ If clicking resize handle, DO NOT drag
  if (e.target.classList.contains('resize-handle')) return;

  e.stopPropagation();
  activeDrag = box;

  const rect = box.getBoundingClientRect();
  box.dataset.offsetX = e.clientX - rect.left;
  box.dataset.offsetY = e.clientY - rect.top;
});

  /* ================================
   ADD RESIZE HANDLES TO BOX
================================ */
const handles = [
  't','b','l','r',
  'tl','tr','bl','br'
];

handles.forEach(pos => {
  const h = document.createElement('div');
  h.className = `resize-handle resize-${pos}`;
  h.dataset.direction = pos;
  box.appendChild(h);
});

  return box;
}




  /* ================================
   GLOBAL DRAG RELEASE & MOVE HANDLERS
   Controls dragging of placed fields
================================ */

document.addEventListener('mouseup', () => {
  if (activeDrag && activeDrag.__field) {
    const f = activeDrag.__field;
const pageEl = activeDrag.closest(".page-container");
const pageW = pageEl.offsetWidth;
const pageH = pageEl.offsetHeight;

f.xPct = activeDrag.offsetLeft / pageW;
f.yPct = activeDrag.offsetTop / pageH;
f.wPct = activeDrag.offsetWidth / pageW;
f.hPct = activeDrag.offsetHeight / pageH;

  }
  activeDrag = null;
});


document.addEventListener('mousemove', (e) => {
  if (!activeDrag) return;

  const pageEl = activeDrag.closest(".page-container");
  if (!pageEl) return;

  const pageRect = pageEl.getBoundingClientRect();

  const x =
    e.clientX -
    pageRect.left -
    Number(activeDrag.dataset.offsetX);

  const y =
    e.clientY -
    pageRect.top -
    Number(activeDrag.dataset.offsetY);

  activeDrag.style.left = (x / pageEl.offsetWidth * 100) + "%";
  activeDrag.style.top  = (y / pageEl.offsetHeight * 100) + "%";
});

/* ================================
   GLOBAL MULTI-DIRECTION RESIZE STATE
================================ */
let resizeTarget = null;
let resizeDir = null;
let startX, startY, startW, startH, startLeft, startTop;

document.addEventListener('mousedown', (e) => {
  const handle = e.target.closest('.resize-handle');
  if (!handle) return;

  e.stopPropagation();

  resizeTarget = handle.parentElement;
  resizeDir = handle.dataset.direction;

  activeDrag = null; // ðŸ”‘ stop dragging

  startX = e.clientX;
  startY = e.clientY;
  startW = resizeTarget.offsetWidth;
  startH = resizeTarget.offsetHeight;
  startLeft = resizeTarget.offsetLeft;
  startTop = resizeTarget.offsetTop;
});


document.addEventListener('mousemove', (e) => {
  if (!resizeTarget) return;

  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  const minW = 20;
  const minH = 10;

  if (resizeDir.includes('r')) {
    resizeTarget.style.width =
      Math.max(minW, startW + dx) + 'px';
  }

  if (resizeDir.includes('l')) {
    const newW = Math.max(minW, startW - dx);
    resizeTarget.style.width = newW + 'px';
    resizeTarget.style.left = startLeft + (startW - newW) + 'px';
  }

  if (resizeDir.includes('b')) {
    resizeTarget.style.height =
      Math.max(minH, startH + dy) + 'px';
  }

  if (resizeDir.includes('t')) {
    const newH = Math.max(minH, startH - dy);
    resizeTarget.style.height = newH + 'px';
    resizeTarget.style.top = startTop + (startH - newH) + 'px';
  }
});


document.addEventListener('mouseup', () => {
  if (resizeTarget && resizeTarget.__field) {
    const f = resizeTarget.__field;
    const pageEl = resizeTarget.closest(".page-container");
const pageW = pageEl.offsetWidth;
const pageH = pageEl.offsetHeight;

f.xPct = resizeTarget.offsetLeft / pageW;
f.yPct = resizeTarget.offsetTop / pageH;
f.wPct = resizeTarget.offsetWidth / pageW;
f.hPct = resizeTarget.offsetHeight / pageH;
;
  }
  resizeTarget = null;
  resizeDir = null;
});






pdfViewer.addEventListener('click', (e) => {
  // âŒ If clicking an existing box, do nothing
  if (e.target.closest('.signature-box')) return;

  if (!currentFieldType) return;

  const pageEl = e.target.closest(".page-container");
if (!pageEl) return;

const pageRect = pageEl.getBoundingClientRect();

const x = e.clientX - pageRect.left;
const y = e.clientY - pageRect.top;

const pageW = pageEl.offsetWidth;
const pageH = pageEl.offsetHeight;



  const box = createSignatureBox(currentFieldType);
box.style.left = (x / pageW * 100) + "%";
box.style.top = (y / pageH * 100) + "%";


    pageEl.appendChild(box);


  enforceSignerLock(); // âœ… FIX 2 â€” ENFORCE LOCK AFTER BOX CREATION

  const field = {
  id: crypto.randomUUID(),
  signer: currentSigner,
  type: currentFieldType,

 value:
    currentFieldType === 'name'
      ? document.getElementById(`signer${currentSigner}_name`)?.value || ''
      : '',

  page: Number(pageEl.dataset.page),

  xPct: x / pageW,
  yPct: y / pageH,
  wPct: box.offsetWidth / pageW,
  hPct: box.offsetHeight / pageH
};


box.__field = field;
fieldList.push(field);




});



    // Click-to-Drop Logic
    const overlay = document.getElementById('overlay-layer');
    

/* RESOURCE BUTTON LOGIC (Webhook #2) */
async function requestResourceDoc(docType) {
  const jiraCode =
    document.getElementById("jira_code")?.value?.trim();

  const requestorEmail =
    document.getElementById("signer1_email")?.value || "Internal HR Request";

  const requestorName =
    document.getElementById("signer1_name")?.value || "Internal Staff";

  // ðŸ”’ Hard validation
  if (!jiraCode) {
    alert("Jira code is required before requesting this document.");
    return;
  }

  try {
    await fetch(RESOURCE_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "request_document",
        document_type: docType,
        jira_code: jiraCode,
        requestor_name: requestorName,
        requestor_email: requestorEmail,
        timestamp: new Date().toISOString()
      })
    });

    alert(`${docType} requested successfully for ${jiraCode}!`);
  } catch (err) {
    console.error("Resource request failed:", err);
    alert("Request failed.");
  }
}


async function submitData() {
  try {
    const selectedTemplate = templateSelect.value;

    const basePayload = {
      jira: document.getElementById("jira_code")?.value || "",
      template: selectedTemplate,
      pdf_url: TEMPLATE_PDFS[selectedTemplate],
      custom_email: document.getElementById("custom_email_message")?.value || ""
    };

    const signers = [
      { signer_order: 1, name: signer1_name.value, email: signer1_email.value },
      { signer_order: 2, name: signer2_name.value, email: signer2_email.value },
      { signer_order: 3, name: signer3_name.value, email: signer3_email.value },
      { signer_order: 4, name: signer4_name.value, email: signer4_email.value }
    ].filter(s => s.email);

    /* =========================
       1ï¸âƒ£ CREATE DOCUMENT (PARENT)
    ========================= */
    const { data: doc, error: docError } = await sb
      .from("signer_documents")
      .insert({
  jira_code: basePayload.jira,
  title:
    document.getElementById("document_title")?.value ||
    generateDocumentTitle(),
  template_name: basePayload.template,
  pdf_url: window.UPLOADED_PDF_URL || basePayload.pdf_url,
  custom_email: basePayload.custom_email
})

      .select()
      .single();

    if (docError) throw docError;

    const docId = doc.doc_id;

 /* =========================
   2.5 INSERT SIGNERS
========================= */

let signerRows = []; // ðŸ”‘ MUST exist outside IF

if (signers.length) {
  signerRows = signers.map(s => ({
    doc_id: docId,
    signer_order: s.signer_order,
    name: s.name,
    email: s.email,
    token: crypto.randomUUID()
  }));

  const { error: signerError } = await sb
    .from("signers")
    .insert(signerRows);

  if (signerError) throw signerError;
}

/* =========================
   2.7 INSERT DOCUMENT FIELDS   â† ADD THIS
========================= */
if (fieldList.length) {
  const fieldRows = fieldList.map(f => ({
    doc_id: docId,
    signer_order: f.signer,
    field_type: f.type,
    value: f.value || "",
    page: f.page,
    x_pct: f.xPct,
    y_pct: f.yPct,
    w_pct: f.wPct,
    h_pct: f.hPct
  }));

  const { error: fieldError } = await sb
    .from("document_fields")
    .insert(fieldRows);

  if (fieldError) throw fieldError;
}

   /* =========================
   3ï¸âƒ£ TRIGGER MAKE EMAIL (FLAT PAYLOAD)
========================= */
await fetch(MAKE_WEBHOOK_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    doc_id: docId,
  title:
    document.getElementById("document_title")?.value ||
    generateDocumentTitle(),

    template: basePayload.template,
    pdf_url: basePayload.pdf_url,
    custom_email: basePayload.custom_email,

    // ðŸ”¥ FLAT SIGNER FIELDS (no arrays)
    signer1_name: signerRows[0]?.name || null,
    signer1_email: signerRows[0]?.email || null,
    signer1_token: signerRows[0]?.token || null,

    signer2_name: signerRows[1]?.name || null,
    signer2_email: signerRows[1]?.email || null,
    signer2_token: signerRows[1]?.token || null,

    signer3_name: signerRows[2]?.name || null,
    signer3_email: signerRows[2]?.email || null,
    signer3_token: signerRows[2]?.token || null,

    signer4_name: signerRows[3]?.name || null,
    signer4_email: signerRows[3]?.email || null,
    signer4_token: signerRows[3]?.token || null
  })
});

alert("Document sent successfully for signature.");

} catch (err) {
  console.error("Submit failed:", err);
  alert("Failed to send document. Check console.");
}
}
  
  






    
    /* DELETE FIELD â€” REMOVE FROM UI + DATA */
document.addEventListener('keydown', (e) => {
  if (!selectedBox) return;

  if (e.key === 'Delete' || e.key === 'Backspace') {
    const fieldId = selectedBox.__field?.id;

    // remove DOM
    selectedBox.remove();

    // remove from data model
    if (fieldId) {
      fieldList = fieldList.filter(f => f.id !== fieldId);
    }

    selectedBox = null;
  }
});


function setSigner(n, btn) {
  currentSigner = n;

  // toggle active UI
  document
    .querySelectorAll('#btn-signer1, #btn-signer2, #btn-signer3, #btn-signer4')
    .forEach(b => b.classList.remove('active'));

  btn.classList.add('active');
  enforceSignerLock();
}

function enforceSignerLock() {
  document.querySelectorAll('.signature-box').forEach(box => {
    const signer = Number(box.dataset.signer);
    box.style.pointerEvents =
      signer === currentSigner ? 'auto' : 'none';
    box.style.opacity =
      signer === currentSigner ? '1' : '0.4';
  });
}


function updateSignerVisibility() {
  const count = Number(document.getElementById('signer_count').value);

  for (let i = 2; i <= 4; i++) {
    const row = document.getElementById(`signer${i}_row`);
    if (!row) continue;
    row.style.display = i <= count ? 'block' : 'none';
  }
}

const CANDIDATE_LOOKUP_WEBHOOK =
  "https://hook.us1.make.com/sg30vwpdf5tywoykjmyj3nj0vuyph5bl";

let candidates = [];

// Fetch from Make
async function fetchCandidates() {
  try {
    const res = await fetch(CANDIDATE_LOOKUP_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "get_signers" })
    });

    if (!res.ok) throw new Error("Lookup failed");

    const data = await res.json();

// ðŸ”‘ Make returns an ARRAY directly
candidates = Array.isArray(data) ? data : [];

showDropdown(candidates);


  } catch (err) {
    console.error("Candidate lookup error:", err);
    alert("Could not load candidates");
  }
}


// Filter as you type
function filterCandidates(query) {
  if (!candidates.length) return;

  const q = query.toLowerCase();

  const filtered = candidates
    .filter(c =>
      c.name?.toLowerCase().includes(q) ||
      c.email?.toLowerCase().includes(q) ||
      c.jira_code?.toLowerCase().includes(q)
    )
    .slice(0, 10);

  showDropdown(filtered);
}


// Render dropdown
function showDropdown(list) {
  const dropdown = document.getElementById("candidate-dropdown");
  dropdown.innerHTML = "";

  if (!list.length) {
    dropdown.classList.add("hidden");
    return;
  }

  list.forEach(c => {
    const div = document.createElement("div");
    div.className = "candidate-item";
    div.innerHTML = `
      <strong>${c.name}</strong><br>
      <span style="color:#64748b">
        ${c.email} â€¢ ${c.jira_code || ""}
      </span>
    `;

    div.onclick = () => applyCandidate(c);
    dropdown.appendChild(div);
  });

  dropdown.classList.remove("hidden");
}


// Apply selection
function applyCandidate(c) {
  document.getElementById("signer1_name").value = c.name || "";
  document.getElementById("signer1_email").value = c.email || "";
  document.getElementById("jira_code").value = c.jira_code || "";

  document.getElementById("candidate-dropdown").classList.add("hidden");
}


// Click-away close
// Click-away close (SAFE VERSION)
document.addEventListener("click", e => {
  if (
    e.target.closest("#candidate-dropdown") ||
    e.target.closest("#signer1_name") ||
    e.target.closest(".tool-btn") // ðŸ”‘ allows Get button
  ) {
    return;
  }

  document
    .getElementById("candidate-dropdown")
    ?.classList.add("hidden");
});


const templateSelect = document.getElementById("template-select");
const titleInput = document.getElementById("document_title");
const emailBox = document.getElementById("custom_email_message");
const signer1NameInput = document.getElementById("signer1_name");

// ================================
// AUTO DOCUMENT TITLE SYSTEM
// ================================
function generateDocumentTitle() {
  const titleInput = document.getElementById("document_title");

  // ðŸ”¹ If HR manually edited â†’ respect it
  if (titleInput?.dataset.manual) return titleInput.value;

  // ðŸ”¹ Base title priority
  let baseTitle = "";

  // 1ï¸âƒ£ Uploaded file name (stored on title input)
  if (titleInput?.dataset.uploadName) {
    baseTitle = titleInput.dataset.uploadName;
  }

  // 2ï¸âƒ£ Template name
  else if (templateSelect.value) {
    baseTitle = templateSelect.value;
  }

  // 3ï¸âƒ£ Fallback
  else {
    baseTitle = "Document";
  }

  // ðŸ”¹ Append signer name if exists
  const signerName =
    document.getElementById("signer1_name")?.value?.trim() || "";

  return signerName ? `${baseTitle} â€“ ${signerName}` : baseTitle;
}




// ðŸ” Sync Name fields when signer name changes
function attachNameSync(signerNum) {
  const input = document.getElementById(`signer${signerNum}_name`);
  if (!input) return;

  input.addEventListener("input", () => {
    document.querySelectorAll('.signature-box').forEach(box => {
      if (
        box.dataset.type === 'name' &&
        Number(box.dataset.signer) === signerNum
      ) {
        box.innerText = input.value || `Name â€“ Signer ${signerNum}`;
      }
    });

    fieldList.forEach(f => {
      if (f.type === 'name' && f.signer === signerNum) {
        f.value = input.value || '';
      }
    });
  });
}

// ðŸ”‘ attach for all possible signers
[1, 2, 3, 4].forEach(attachNameSync);



const TEMPLATE_EMAILS = {
  "Contractor Agreement": (name) => `
Hi ${name || "there"},

Attached is the Independent Contractor Agreement for your review.

Please read through the document and sign where indicated.
If you have any questions, let us know before signing.

Thank you,
Neat & Necessary Cleaning
`.trim(),

  "Background Check Agreement": (name) => `
Hi ${name || "there"},

This email contains the Background Check Authorization form required to proceed.

Please review and sign the document at your earliest convenience.
Once completed, we can move forward with the next steps.

Thank you,
Neat & Necessary Cleaning
`.trim(),

  "W-9": (name) => `
Hi ${name || "there"},

Please complete and sign the attached W-9 form.

This is required for payment and onboarding purposes.
Let us know if you have any questions.

Thank you,
Neat & Necessary Cleaning
`.trim()
};

let activeTemplateBlobUrl = null;

async function loadPdfFromGoogleDrive(driveUrl) {
  // Clean up previous blob
  if (activeTemplateBlobUrl) {
    URL.revokeObjectURL(activeTemplateBlobUrl);
    activeTemplateBlobUrl = null;
  }

  const res = await fetch(driveUrl, {
    method: "GET",
    credentials: "omit",
    cache: "no-store"
  });

  if (!res.ok) {
    throw new Error("Fetch failed: " + res.status);
  }

  const blob = await res.blob();

  // ðŸ”‘ HARD GUARD â€” prevents silent Drive HTML failures
  if (blob.type !== "application/pdf") {
    console.error("Google returned:", blob.type);
    throw new Error("Not a PDF");
  }

  activeTemplateBlobUrl = URL.createObjectURL(blob);
  return activeTemplateBlobUrl;
}


templateSelect.addEventListener("change", async () => {
  resetDocumentState(); // ðŸ”¥ REQUIRED

  const template = templateSelect.value;
// Auto-generate title if HR hasn't manually changed it
if (titleInput && !titleInput.dataset.manual) {
  titleInput.value = generateDocumentTitle();
}


  /* --------------------
     EMAIL (unchanged)
  -------------------- */


  /* --------------------
     EMAIL (unchanged)
  -------------------- */
  if (!template) {
    emailBox.value = "";
  } else {
    const signerName = signer1NameInput.value?.trim();
    const generator = TEMPLATE_EMAILS[template];
    if (generator) {
      emailBox.value = generator(signerName);
    }
  }

  /* --------------------
     PDF (Google-safe)
  -------------------- */
  if (!template) {
    document.getElementById("pdf-viewer").innerHTML = `
      <p style="text-align:center;color:#ccc;margin-top:100px;">
        Select a template or upload a PDF
      </p>
    `;
    return;
  }

  const driveUrl = TEMPLATE_PDFS[template];
  if (!driveUrl) return;

  document.getElementById("upload-text").innerHTML =
    `âœ“ Template Loaded: ${template}`;

  try {
    const blobUrl = await loadPdfFromGoogleDrive(driveUrl);
    await renderPDF(blobUrl);
  } catch (err) {
    console.error("Template PDF load failed:", err);
    alert("Could not load template PDF");
  }




enforceSignerLock();
updateSignerVisibility(); // ensure signer rows match dropdown on load
});

</script>

</body>
</html>
